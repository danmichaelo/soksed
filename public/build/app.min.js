angular.module("app.config",[]).constant("config",{views:[{id:1,name:"default",label:"Standard"},{id:2,name:"nn",label:"Omsetjing til nynorsk"}],filters:[{value:"",label:"(intet filter)"},{value:"has:unverified",label:"Ikke korrekturlest"},{value:"exists:prefLabel@nn",label:"Har språk:nynorsk",graphOption:!0},{value:"-exists:prefLabel@nn",label:"Mangler språk:nynorsk"},{value:"has:editorialNote",label:"Har noter",graphOption:!0}],languages:["nb","nn","en","la"]}),angular.module("app",["ngSanitize","vs-repeat","cfp.hotkeys","ui.router","720kb.tooltips","app.config","app.controllers.header","app.controllers.user","app.controllers.users","app.controllers.concept","app.controllers.concepts","app.controllers.auth","app.services.user","app.services.backend","app.services.auth","app.services.concepts","app.services.concept","app.services.state","app.directives.altlabels","app.directives.conceptnav"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","$logProvider","hotkeysProvider",function(e,t,n,r,o){"use strict";r.debugEnabled(!0),o.includeCheatSheet=!0;var a="nn",s={"^REAL([0-9]+)$":"http://data.ub.uio.no/realfagstermer/c"},c="?ver=2";e.state("home",{url:"/",templateUrl:"partials/home.html"+c}).state("concepts",{url:"/concepts?q",templateUrl:"partials/concepts.html"+c,needsPermission:"edit",controller:"ConceptsController"}).state("concepts.concept",{needsPermission:"edit",url:"/:id?view",templateUrl:function(e){return"/partials/concept."+(e.view?e.view:a)+".html"+c},controller:"ConceptController",resolve:{concept:["$stateParams","Concepts","StateService",function(e,t,n){var r=e.id;n.setView(e.view?e.view:a);var o;if(Object.keys(s).forEach(function(e){var t=r.match(e);t&&(o=s[e]+t[1])}),!o)return void n.setConcept(null);var c=t.getByUri(o);return c||(c=t.add(r,o)),n.setConcept(c),c}]}}).state("users",{url:"/users",templateUrl:"partials/users.html"+c,controller:"UsersController",needsPermission:"edit",resolve:{users:["$http",function(e){return e({method:"GET",url:"api.php",params:{action:"get_users"}})}]}}).state("user",{url:"/users/:id",templateUrl:"partials/user.html"+c,controller:"UserController",needsPermission:"view",resolve:{user:["$stateParams","User",function(e,t){return t.get(e.id)}]}}).state("auth",{url:"/auth?returnTo",templateUrl:"partials/auth.html"+c,controller:"AuthController",resolve:{returnTo:["$stateParams",function(e){return e.returnTo}]}}),n.html5Mode(!0)}]).run(["$rootScope","$location","$state","Auth",function(e,t,n,r){"use strict";e.$on("$stateChangeStart",function(e,t,o){if(console.log('$stateChangeStart: has "'+t.needsPermission+'" permission ? '+(r.hasPermission(t.needsPermission)?"yes":"no")),!r.hasPermission(t.needsPermission)){e.preventDefault();var a=n.href(t,o);r.isLoggedIn()?n.go("user",{id:r.user.username[0]}):n.go("auth",{returnTo:a})}})}]),angular.module("app.directives.altlabels",["app.services.state"]).directive("altlabels",["StateService",function(e){"use strict";return{restrict:"E",templateUrl:"/partials/altlabels.html",replace:!1,scope:{items:"=",originalItems:"=",lang:"@",disabled:"@"},link:function(t,n,r){function o(){}t.keydown=function(e){if(13===e.keyCode&&t.items.push({value:""}),40===e.keyCode){var n=$(e.target).parent(),r=n.parent().children("li");if(r.length<=1)return;var o=n.next("li");0===o.length&&(o=$(r[0])),o.find("input").focus()}38===e.keyCode},t.setCurrentTerm=function(n){var r=$(n.target).parent(),o=r.parent().children("li").index(r),a=t.items[o];e.setTerm(a)},t.markReviewed=function(e){console.log("Mark reviewed: "+e),window.alert("not implemented")},r.items?o(r.lang,r.items):n.html("<em>No items provided</em>")}}}]),angular.module("app.directives.conceptnav",["app.config","app.services.concepts","app.services.state"]).directive("conceptnav",["$state","$location","hotkeys","StateService","Concepts","config",function(e,t,n,r,o,a){"use strict";return{restrict:"E",templateUrl:"/partials/conceptnav.html",replace:!1,scope:{filterobj:"="},link:function(t){console.log(">>> Linking conceptnav"),t.filters=a.filters,t.concepts=[],t.busy=!0,t.totalCount=o.count,n.bindTo(t).add({combo:"/",description:"Søk",callback:function(e){e.preventDefault(),$(".conceptnav input:text").focus()}}),t.selectConcept=function(){o.show(this.concept)},t.currentConcept=r.getConcept(),t.checkScrollPos=function(e){var n=$(".scrollerwrapper").children().first().height(),r=t.concepts.indexOf(e),o=r*n,a=o+n,s=$(".scrollerwrapper").scrollTop(),c=s+$(".scrollerwrapper").height();-1!==r&&e&&(a>=c?$(".scrollerwrapper").scrollTop(a-$(".scrollerwrapper").height()):s>=o&&$(".scrollerwrapper").scrollTop(o))},t.$on("conceptChanged",function(e,n){t.currentConcept=n,t.checkScrollPos(n)}),t.graphOptionEnabled=function(){return t.filterobj.select&&t.filterobj.select.graphOption},t.submit=function(){var n=[];t.filterobj.query&&n.push(t.filterobj.query),t.filterobj.select&&n.push(t.filterobj.select.value),t.graphOptionEnabled()&&t.filterobj.local&&n.push("graph:local"),console.log(n),e.go("concepts.concept",{q:n.join(",")})};var s=[];t.filterobj.query&&s.push(t.filterobj.query),t.filterobj.select&&s.push(t.filterobj.select.value),t.filterobj.local&&s.push("graph:local"),s=s.join(","),console.log(s),o.busy||(t.busy=!0,o.fetch(s).then(function(e){t.concepts=e,t.totalCount=o.count,t.busy=!1,setTimeout(function(){t.checkScrollPos(t.currentConcept)})})["catch"](function(e){t.concepts=[],t.totalCount=0,t.error=e,t.busy=!1}))}}}]),angular.module("app.directives.term",["app.services.state","app.services.backend"]).directive("term",["StateService","Backend",function(e,t){"use strict";return{restrict:"E",transclude:!0,templateUrl:"/partials/term.html",replace:!1,scope:{data:"=",originalData:"=",readonly:"="},link:function(n){n.markReviewed=function(){var e=!0;n.$parent.currentConcept.dirty&&(e=window.confirm("Endringer du har gjort på dette begrepet vil gå tapt. Vil du fortsette?")),e&&t.markReviewed(n.originalData.uri).then(function(){n.$parent.reload()})},n.keydown=function(e){if(13===e.keyCode,40===e.keyCode||38===e.keyCode){var t,n=$(e.target).parent(),r=n.parent().children("term");if(r.length<=1)return;40==e.keyCode?(t=n.next("term"),0===t.length&&(t=$(r[0]))):(t=n.prev("term"),0===t.length&&(t=$(r[r.length-1]))),t.find("input").focus()}},n.focus=function(t){e.setTerm(n.data),$(t.target).select()}}}}]),angular.module("app.controllers.auth",["app.services.auth"]).controller("AuthController",["$scope","Auth","returnTo",function(e,t,n){"use strict";e.returnTo=window.encodeURIComponent(n)}]),angular.module("app.controllers.concept",["app.services.backend","app.services.auth","app.services.state","app.services.concepts"]).controller("ConceptController",["$scope","$window","$log","$timeout","hotkeys","Backend","Concepts","concept",function(e,t,n,r,o,a,s,c){"use strict";function i(){r(function(){var e=angular.element('.main input[type="text"]:enabled');e.length&&e[0].focus()},0)}if(!c)return void console.log("[ConceptController] Init: no concept");console.log("[ConceptController] Init: id="+c.id),e.currentConcept=c,c.isLoaded()&&i(),e.$on("conceptLoaded",function(){i()}),e.$watch("currentConcept.data",function(t,n){n&&t&&n.uri==t.uri&&e.currentConcept.testDirty()},!0),e.store=function(){e.currentConcept.dirty&&e.currentConcept.store()},e.storeAndGo=function(){e.store(),s.next()},e.reload=function(){n.debug("[main] Reload concept"),e.currentConcept.load(!0)};var l="alt";"MacIntel"==navigator.platform&&(l="ctrl"),o.bindTo(e).add({combo:l+"+s",description:"Lagre og hopp til neste",callback:function(t){t.preventDefault(),e.storeAndGo()},allowIn:["INPUT"]}).add({combo:l+"+shift+s",description:"Lagre",callback:function(t){t.preventDefault(),e.store()},allowIn:["INPUT"]}).add({combo:l+"+down",description:"Hopp til neste",callback:function(e){e.preventDefault(),s.next()},allowIn:["INPUT"]}).add({combo:l+"+up",description:"Hopp til forrige",callback:function(e){e.preventDefault(),s.prev()},allowIn:["INPUT"]}).add({combo:l+"+k",description:"Vis katalogposter",callback:function(t){t.preventDefault(),window.open(e.currentConcept.katapiUrl,"katapi")},allowIn:["INPUT"]})}]),angular.module("app.controllers.concepts",["app.config","app.services.backend"]).controller("ConceptsController",["$scope","$state","$stateParams","Backend","StateService","config",function(e,t,n,r,o,a){"use strict";function s(t){if(t)for(var n=e.views.length-1;n>=0;n--)if(e.views[n].name==t){e.selectedView=e.views[n];break}}console.log("-- ConceptsController --"),e.filterobj={},n.q&&n.q.split(",").forEach(function(t){var n=a.filters.map(function(e){return e.value}),r=a.filters[n.indexOf(t)];void 0!==r?e.filterobj.select=r:t.match("(graph:local)")?e.filterobj.local=!0:e.filterobj.query=t}),e.filterobj.select||(e.filterobj.select=a.filters[0]),e.selectedLanguages=a.languages,e.views=a.views,s(o.getView()),e.$on("viewChanged",function(e,t){s(t)}),e.$watch("selectedView",function(e,n){n&&e&&n!=e&&t.go("concepts.concept",{view:e.name})}),e.currentConcept=o.getConcept(),e.$on("conceptChanged",function(t,n){console.log("[ConceptsController] Concept changed: "),console.log(n),e.currentConcept=n})}]),angular.module("app.controllers.header",["app.services.auth"]).controller("HeaderController",["$scope","Auth",function(e,t){"use strict";e.menuAvailable=!0,e.toggleMenu=function(){angular.element("body").toggleClass("menuVisible")},e.user=t.user,e.$on("userChanged",function(t,n){e.user=n})}]),angular.module("app.controllers.user",["app.services.auth"]).controller("UserController",["$scope","user",function(e,t){"use strict";console.log(t),e.user=t.data.user}]),angular.module("app.controllers.users",["app.services.backend","app.services.auth","app.services.state","app.services.concepts"]).controller("UsersController",["$scope","users",function(e,t){"use strict";console.log(t),e.users=t.data.users}]),angular.module("app.services.auth",["ngCookies","app.services.backend"]).service("Auth",["$rootScope","$cookieStore",function(e,t){"use strict";var n=t.get("user")||{username:"",permission:[]};this.user=n;var r=this;this.hasPermission=function(e){return e?"view"==e?r.isLoggedIn():-1!=r.user.permission.indexOf(e)?!0:!1:!0},this.isLoggedIn=function(e){return void 0===e&&(e=r.user),e.created},this.user=n}]),angular.module("app.services.backend",[]).service("Backend",["$rootScope","$http",function(e,t){"use strict";function n(e,n){return n||(n={}),n.action=e,t({method:"GET",url:"api.php",params:n})}function r(e,n){return n||(n={}),n.action=e,t({method:"POST",url:"api.php",data:n})}this.getUser=function(e){var t={};return e&&(t.id=e),n("get_user",t)},this.getUsers=function(){return n("get_users")},this.getConcepts=function(e,t){return n("get_concepts",{cursor:e,filter:t})},this.getConcept=function(e){return n("get_concept",{uri:e})},this.putConcept=function(e){return r("put_concept",{data:e})},this.markReviewed=function(e){return r("mark_reviewed",{uri:e})}}]),angular.module("app.services.concept",["app.config","app.services.backend","app.directives.altlabels","app.directives.term"]).factory("Concept",["$q","$rootScope","$timeout","Backend","config",function(e,t,n,r,o){"use strict";function a(e,t,n){var r=this;r.dirty=!1,r.loading=!1,r.saving=!1,r.saved=!1,r.error=null,r.id=e,r.uri=t,r.label=n,r.status="minimal",r.data=null}return a.prototype={constructor:a,isLoaded:function(){return this.data},setData:function(e){e.editorialNote?e.editorialNote[0].readonly&&e.editorialNote.push({value:""}):e.editorialNote=[{value:""}],e.altLabel&&Object.keys(e.altLabel).length||(e.altLabel={}),o.languages.forEach(function(t){e.prefLabel[t]||(e.prefLabel[t]=[{value:""}]),e.altLabel[t]||(e.altLabel[t]=[{value:""}])}),this.ensureBlankFields(e),this.generateHints(e);var n=this.label;this.label=e.prefLabel.nb[0].value,this.data=e,this.originalData=angular.copy(e),n!=this.label&&t.$broadcast("conceptLabelChanged",this);var r=encodeURIComponent(this.label);this.katapiUrl="https://katapi.biblionaut.net/documents?q=real:"+this.label;var a=encodeURIComponent("\n\n\n\n--\nURI: "+this.uri+"\nBruk: "+this.katapiUrl);this.githubUrl="https://github.com/realfagstermer/realfagstermer/issues/new?title="+r+"&body="+a},testDirty:function(){this.dirty=!angular.equals(this.data,this.originalData),this.ensureBlankFields(this.data)},generateHints:function(e){var t;e.prefLabel.nn[0].hints=[],e.prefLabel.nb[0].value&&e.prefLabel.nn[0].hints.push(e.prefLabel.nb[0].value),t=e.prefLabel.nb[0].value.match("^(.*)er$"),t&&e.prefLabel.nn[0].hints.push(t[1]+"ar");for(var n=0;n<Math.min(e.altLabel.nn.length,e.altLabel.nb.length);n++)e.altLabel.nn[n].hints=[],e.altLabel.nb[n].value&&e.altLabel.nn[n].hints.push(e.altLabel.nb[n].value),t=e.altLabel.nb[n].value.match("^(.*)er$"),t&&e.altLabel.nn[n].hints.push(t[1]+"ar")},ensureBlankFields:function(e){var t=this;o.languages.forEach(function(n){(0===e.altLabel[n].length||""!==e.altLabel[n][e.altLabel[n].length-1].value)&&(e.altLabel[n].push({value:""}),t.generateHints(e)),e.altLabel[n].length>=2&&""===e.altLabel[n][e.altLabel[n].length-1].value&&""===e.altLabel[n][e.altLabel[n].length-2].value&&(e.altLabel[n]=e.altLabel[n].slice(0,e.altLabel[n].length-1))})},store:function(){var e=this;e.error="",e.saved=!1,e.dirty=!1,this.saving=!0,r.putConcept(this.data).then(function(t){return e.saving=!1,console.log(t),t.data.status?"success"!=t.data.status?void("edit_conflict"==t.data.status?(e.error='Redigeringskonflikt: Begrepet har blitt endret på serveren siden du begynte å redigere. Kopier ulagrede endringer og trykk så "Tilbakestill" (eller last siden på nytt) for å hente inn det oppdaterte begrepet.',window.alert("Redigeringskonflikt, endringene dine har ikke blitt lagret.")):"no_permission"==t.data.status?(e.error="Beklager, du har ikke redigeringstilgang. Hvis du nettopp har registrert deg må du vente på at kontoen blir godkjent.",window.alert("Beklager, du har ikke redigeringstilgang. Hvis du nettopp har registrert deg må du vente på at kontoen blir godkjent.")):(e.error=t.data.status,window.alert("Save failed, see concept for more info."))):(e.saved=!0,void e.load(!0)):(e.error=t.data,void window.alert("Save failed, see concept for more info."))})["catch"](function(t){e.saving=!1,console.log(t),e.error="Invalid response received: "+t.message,window.alert("Save failed!")})},load:function(o){var a=this,s=e.defer();return this.data&&!o?n(function(){s.resolve()},0):(this.loading=!0,r.getConcept(this.uri).success(function(e){return a.loading=!1,e.concept?(a.setData(e.concept),a.error=null,console.log("[Concept] Concept loaded: "+e.concept.uri),console.log(a.data),t.$broadcast("conceptLoaded",a),void s.resolve()):(a.error=e.error?e.error:e,void s.reject())}).error(function(){a.loading=!1,a.error="Load failed. Server or network problems.",s.reject()})),s.promise},toJson:function(){var e={},t=this;return Object.keys(this).forEach(function(n){"originalData"!=n&&(e[n]=t[n])}),JSON.stringify(e)}},a}]),angular.module("app.services.concepts",["app.services.backend","app.services.concept"]).service("Concepts",["$rootScope","$q","$timeout","$state","Backend","Concept",function(e,t,n,r,o,a){"use strict";var s=this,c=null,i=null;this.busy=!1,this.concepts=[],this.cursor=0,this.count=0,e.$on("conceptChanged",function(e,t){c=t,c.data||c.load()}),e.$on("conceptLabelChanged",function(){console.log("Label changed, re-sort list")}),this.fetch=function(n){if(!s.busy){var r=t.defer();return n!=i&&(s.concepts=[],i=n),console.log("[Concepts] fetchConcepts"),s.busy=!0,o.getConcepts(s.cursor,n).success(function(t){return s.busy=!1,t.concepts?(s.count=t.count,s.count!=s.concepts.length&&(s.concepts=[]),s.cursor=t.cursor,t.concepts.forEach(function(e,t){s.cursor+t;s.getByUri(e.uri)||s.concepts.push(c&&c.uri==e.uri?c:new a(e.id,e.uri,e.label))}),console.log("[Concepts] Fetched"),e.$broadcast("loadedConcepts",s.concepts),void r.resolve(s.concepts)):(console.log("[Concepts] Fetch failed!"),s.count=0,s.concepts=[],void r.reject(t))}),r.promise}},this.getConcepts=function(){return s.concepts},this.getById=function(e){return s.concepts.reduce(function(t,n){return n.id==e?n:t},null)},this.getByUri=function(e){return s.concepts.reduce(function(t,n){return n.uri==e?n:t},null)},this.sort=function(){s.concepts.sort(function(e,t){return e.label.localeCompare(t.label)})},this.add=function(e,t){console.log("[Concepts] Add <"+t+"> to the current list of "+s.concepts.length+" concepts.");var n=new a(e,t,"(...)");return s.concepts.push(n),n},this.show=function(e){r.go("concepts.concept",{id:e.id})},this.next=function(){var e=s.concepts.indexOf(c);if(-1==e)return void console.log("Current concept is not part of the current concept list");var t=e+1;t>s.concepts.length-1&&(t=0),s.show(s.concepts[t])},this.prev=function(){var e=s.concepts.indexOf(c);if(-1==e)return void console.log("Current concept is not part of the current concept list");var t=e-1;0>t&&(t=s.concepts.length-1),s.show(s.concepts[t])}}]),angular.module("app.services.state",["app.services.concepts"]).service("StateService",["$rootScope","Concepts",function(e){"use strict";var t={concept:null,term:null,view:null};this.setView=function(n){n!=t.view&&(t.view=n,console.log("[StateService] Set view: "+n),e.$broadcast("viewChanged",t.view))},this.getView=function(){return t.view},this.setConcept=function(n){t.concept!=n&&(t.concept=n,e.$broadcast("conceptChanged",t.concept))},this.getConcept=function(){return t.concept},this.setTerm=function(n){t.term!=n&&(t.term=n,e.$broadcast("termChanged",t.term))},this.getTerm=function(){return t.term}}]),angular.module("app.services.user",["app.services.backend"]).factory("User",["$q","$rootScope","$timeout","Backend",function(e,t,n,r){"use strict";function o(){var e=this;e.data=null}return o.prototype={constructor:o,isLoaded:function(){return this.data},setData:function(e){this.data=e}},o.get=function(t){var n=e.defer();return r.getUser(t).then(function(e){console.log(e),n.resolve(e)}),n.promise},o}]);
//# sourceMappingURL=app.min.js.map