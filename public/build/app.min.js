angular.module("app",["ngSanitize","vs-repeat","cfp.hotkeys","ui.router","app.controllers.user","app.controllers.users","app.controllers.concept","app.controllers.concepts","app.controllers.auth","app.services.user","app.services.backend","app.services.auth","app.services.concepts","app.services.concept","app.services.state","app.directives.altlabels","app.directives.conceptnav"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","$logProvider","hotkeysProvider",function(e,t,n,r,o){"use strict";r.debugEnabled(!0),o.includeCheatSheet=!0;var s="nn",c={"^REAL([0-9]+)$":"http://data.ub.uio.no/realfagstermer/c"};e.state("home",{url:"/",templateUrl:"partials/home.html"}).state("concepts",{url:"/concepts",templateUrl:"partials/concepts.html",needsPermission:"edit",controller:"ConceptsController"}).state("concepts.concept",{needsPermission:"edit",url:"/:id?view",templateUrl:function(e){return"/partials/concept."+(e.view?e.view:s)+".html"},controller:"ConceptController",resolve:{view:["$stateParams",function(e){var t=e.view?e.view:s;return t}],concept:["$stateParams","Concepts",function(e,t){var n,r=e.id;Object.keys(c).forEach(function(e){var t=r.match(e);t&&(n=c[e]+t[1])});var o=t.getByUri(n);return o||(console.log("[main] Add concept <"+n+">"),o=t.add(r,n)),o}]}}).state("users",{url:"/users",templateUrl:"partials/users.html",controller:"UsersController",needsPermission:"edit",resolve:{users:["$http",function(e){return e({method:"GET",url:"api.php",params:{action:"get_users"}})}]}}).state("user",{url:"/users/:id",templateUrl:"partials/user.html",controller:"UserController",needsPermission:"view",resolve:{user:["$stateParams","User",function(e,t){return t.get(e.id)}]}}).state("auth",{url:"/auth?returnTo",templateUrl:"partials/auth.html",controller:"AuthController",resolve:{returnTo:["$stateParams",function(e){return e.returnTo}]}}),n.html5Mode(!0)}]).run(["$rootScope","$location","$state","Auth",function(e,t,n,r){e.$on("$stateChangeStart",function(e,t,o){if(console.log('$stateChangeStart: has "'+t.needsPermission+'" permission ? '+(r.hasPermission(t.needsPermission)?"yes":"no")),!r.hasPermission(t.needsPermission)){e.preventDefault();var s=n.href(t,o);r.isLoggedIn()?n.go("user",{id:r.user.username[0]}):n.go("auth",{returnTo:s})}})}]).controller("LoginCtrl",["$scope","$location","$log","$timeout","Auth","Concepts","StateService",function(e,t,n,r,o){"use strict";e.user=o.user,e.$on("userChanged",function(t,n){e.user=n})}]),angular.module("app.controllers.auth",["app.services.auth"]).controller("AuthController",["$scope","Auth","returnTo",function(e,t,n){"use strict";e.returnTo=window.encodeURIComponent(n)}]),angular.module("app.controllers.concept",["app.services.backend","app.services.auth","app.services.state","app.services.concepts"]).controller("ConceptController",["$scope","$window","$log","$timeout","hotkeys","Backend","StateService","Concepts","concept","view",function(e,t,n,r,o,s,c,a,i,l){"use strict";function u(){r(function(){angular.element('.main input[type="text"]:enabled')[0].focus()},0)}console.log("[ConceptController] Init: view="+l+", id="+i.id),c.setConcept(i),c.setView(l),e.currentConcept=i,i.isLoaded()&&u(),e.$on("conceptLoaded",function(){u()}),e.$watch("currentConcept.data",function(t,n){n&&t&&n.uri==t.uri&&(e.currentConcept.testDirty(),s.config.languages.forEach(function(e){""!==t.altLabel[e][t.altLabel[e].length-1].value&&t.altLabel[e].push({value:""})}))},!0),e.$on("termChanged",function(t,r){n.debug("[main] Term changed: "+r.value),e.currentTerm=r}),e.nb2nn=function(e){return e+"a"},e.selectHint=function(t){n.debug(t),e.currentConcept.data.prefLabel.nn[0].value=t},e.store=function(){e.currentConcept.dirty&&e.currentConcept.store()},e.storeAndGo=function(){e.store(),a.next()},e.reload=function(){n.debug("[main] Reload concept"),e.currentConcept.load(!0)},e.markReviewed=function(t){e.currentConcept.markReviewed(t)};var p="alt";"MacIntel"==navigator.platform&&(p="ctrl"),o.bindTo(e).add({combo:p+"+s",description:"Lagre og hopp til neste",callback:function(t){t.preventDefault(),e.storeAndGo()},allowIn:["INPUT"]}).add({combo:p+"+shift+s",description:"Lagre",callback:function(t){t.preventDefault(),e.store()},allowIn:["INPUT"]}).add({combo:p+"+down",description:"Hopp til neste",callback:function(e){e.preventDefault(),a.next()},allowIn:["INPUT"]}).add({combo:p+"+up",description:"Hopp til forrige",callback:function(e){e.preventDefault(),a.prev()},allowIn:["INPUT"]})}]),angular.module("app.controllers.concepts",["app.services.backend"]).controller("ConceptsController",["$scope","$state","Backend","StateService",function(e,t,n,r){"use strict";function o(t){if(t)for(var n=e.views.length-1;n>=0;n--)if(e.views[n].name==t){e.selectedView=e.views[n];break}}e.selectedLanguages=n.config.languages,e.views=[{id:1,name:"default",label:"Standard"},{id:2,name:"nn",label:"Omsetjing til nynorsk"}],o(r.getView()),e.$on("viewChanged",function(e,t){o(t)}),e.$watch("selectedView",function(e,n){n&&e&&n!=e&&t.go("concepts.concept",{view:e.name})}),e.$on("conceptChanged",function(t,n){console.log("[ConceptsController] Concept changed: "+n.uri),e.currentConcept=n})}]),angular.module("app.controllers.user",["app.services.auth"]).controller("UserController",["$scope","user",function(e,t){"use strict";console.log(t),e.user=t.data.user}]),angular.module("app.controllers.users",["app.services.backend","app.services.auth","app.services.state","app.services.concepts"]).controller("UsersController",["$scope","users",function(e,t){"use strict";console.log(t),e.users=t.data.users}]),angular.module("app.directives.altlabels",["app.services.state"]).directive("altlabels",["StateService",function(e){return{restrict:"E",templateUrl:"/partials/altlabels.html",replace:!1,scope:{items:"=",originalItems:"=",lang:"@",disabled:"@"},link:function(t,n,r){function o(){}t.keydown=function(e){if(13===e.keyCode&&t.items.push({value:""}),40===e.keyCode){var n=$(e.target).parent(),r=n.parent().children("li");if(r.length<=1)return;var o=n.next("li");0===o.length&&(o=$(r[0])),o.find("input").focus()}38===e.keyCode},t.setCurrentTerm=function(n){var r=$(n.target).parent(),o=r.parent().children("li").index(r),s=t.items[o];e.setTerm(s)},t.markReviewed=function(e){console.log("Mark reviewed: "+e),alert("not implemented")},r.items?o(r.lang,r.items):n.html("<em>No items provided</em>")}}}]),angular.module("app.directives.conceptnav",["app.services.concepts","app.services.state"]).directive("conceptnav",["StateService","Concepts",function(e,t){return{restrict:"E",templateUrl:"/partials/conceptnav.html",replace:!1,scope:{},link:function(n){console.log(">>> Linking conceptnav"),n.concepts=[],n.busy=!0,n.filterNn="",n.totalCount=t.count,n.fetchMoreConcepts=function(){console.log("FETCH MORE"),t.fetch()},n.$on("loadedConcepts",function(e,r){n.concepts=r,n.totalCount=t.count,n.busy=!1}),n.selectConcept=function(){t.show(this.concept)},n.currentConcept=e.getConcept(),n.$on("conceptChanged",function(e,t){n.currentConcept=t}),n.filter=function(){var e=[];n.filterQuery&&e.push(n.filterQuery),n.filterNn&&e.push(n.filterNn),e=e.join(","),console.log(e),n.busy=!0,t.fetch(e)},t.fetch()}}}]),angular.module("app.directives.term",["app.services.state"]).directive("term",["StateService",function(e){return{restrict:"E",transclude:!0,templateUrl:"/partials/term.html",replace:!1,scope:{data:"=",originalData:"=",readonly:"="},link:function(t){t.markReviewed=function(){t.$parent.markReviewed(t.originalData.uri)},t.keydown=function(e){if(13===e.keyCode,40===e.keyCode||38===e.keyCode){var t,n=$(e.target).parent(),r=n.parent().children("term");if(r.length<=1)return;40==e.keyCode?(t=n.next("term"),0===t.length&&(t=$(r[0]))):(t=n.prev("term"),0===t.length&&(t=$(r[r.length-1]))),t.find("input").focus()}},t.focus=function(n){e.setTerm(t.data),$(n.target).select()}}}}]),angular.module("app.services.auth",["ngCookies","app.services.backend"]).service("Auth",["$rootScope","$cookieStore",function(e,t){"use strict";console.log("User-cookie: "),console.log(t.get("user"));var n=t.get("user")||{username:"",permission:[]};this.user=n;var r=this;this.hasPermission=function(e){return e?"view"==e?r.isLoggedIn():-1!=r.user.permission.indexOf(e)?!0:!1:!0},this.isLoggedIn=function(e){return void 0===e&&(e=r.user),e.created},this.user=n}]),angular.module("app.services.backend",[]).service("Backend",["$rootScope","$http",function(e,t){"use strict";function n(e,n){return n||(n={}),n.action=e,t({method:"GET",url:"api.php",params:n})}function r(e,n){return n||(n={}),n.action=e,t({method:"POST",url:"api.php",data:n})}this.config={languages:["nb","nn","en","la"]},this.getUser=function(e){var t={};return e&&(t.id=e),n("get_user",t)},this.getUsers=function(){return n("get_users")},this.getConcepts=function(e,t){return n("get_concepts",{cursor:e,filter:t})},this.getConcept=function(e){return n("get_concept",{uri:e})},this.putConcept=function(e){return r("put_concept",{data:e})},this.markReviewed=function(e){return r("mark_reviewed",{uri:e})}}]),angular.module("app.services.concept",["app.services.backend","app.directives.altlabels","app.directives.term"]).factory("Concept",["$q","$rootScope","$timeout","Backend",function(e,t,n,r){"use strict";function o(e,t,n){var r=this;r.dirty=!1,r.loading=!1,r.saving=!1,r.saved=!1,r.error=null,r.id=e,r.uri=t,r.label=n,r.status="minimal",r.data=null}return o.prototype={constructor:o,isLoaded:function(){return this.data},setData:function(e){e.altLabel&&Object.keys(e.altLabel).length||(e.altLabel={}),r.config.languages.forEach(function(t){e.prefLabel[t]||(e.prefLabel[t]=[{value:""}]),e.altLabel[t]||(e.altLabel[t]=[{value:""}])}),e.prefLabel.nn[0].hints=[],e.prefLabel.nn[0].hints.push(e.prefLabel.nb[0].value);var n=e.prefLabel.nb[0].value.match("^(.*)er$");n&&e.prefLabel.nn[0].hints.push(n[1]+"ar");var o=this.label;this.label=e.prefLabel.nb[0].value,this.data=e,this.originalData=angular.copy(e),o!=this.label&&t.$broadcast("conceptLabelChanged",this);var s=encodeURIComponent(this.label);this.katapiUrl="https://katapi.biblionaut.net/documents?q=real:"+this.label;var c=encodeURIComponent("\n\n\n\n--\nURI: "+this.uri+"\nBruk: "+this.katapiUrl);this.githubUrl="https://github.com/realfagstermer/realfagstermer/issues/new?title="+s+"&body="+c},testDirty:function(){this.dirty=!angular.equals(this.data,this.originalData)},markReviewed:function(e){var t=this;console.log("Mark as reviewed: "+e),r.markReviewed(e).then(function(){t.load(!0)})},store:function(){var e=this;e.error="",e.saved=!1,e.dirty=!1,this.saving=!0,r.putConcept(this.data).then(function(t){return e.saving=!1,console.log(t),t.data.status?"success"!=t.data.status?void("edit_conflict"==t.data.status?(e.error='Redigeringskonflikt: Begrepet har blitt endret på serveren siden du begynte å redigere. Kopier ulagrede endringer og trykk så "Tilbakestill" (eller last siden på nytt) for å hente inn det oppdaterte begrepet.',alert("Redigeringskonflikt, endringene dine har ikke blitt lagret.")):"no_permission"==t.data.status?(e.error="Beklager, du har ikke redigeringstilgang. Hvis du nettopp har registrert deg må du vente på at kontoen blir godkjent.",alert("Beklager, du har ikke redigeringstilgang. Hvis du nettopp har registrert deg må du vente på at kontoen blir godkjent.")):(e.error=t.data.status,alert("Save failed, see concept for more info."))):(e.saved=!0,void e.load(!0)):(e.error=t.data,void alert("Save failed, see concept for more info."))})},load:function(o){var s=this,c=e.defer();return this.data&&!o?n(function(){c.resolve()},0):(this.loading=!0,r.getConcept(this.uri).success(function(e){return s.loading=!1,e.concept?(s.setData(e.concept),s.error=null,console.log("[Concept] Concept loaded: "+e.concept.uri),console.log(s.data),t.$broadcast("conceptLoaded",s),void c.resolve()):(s.error=e.error?e.error:e,void c.reject())}).error(function(){s.loading=!1,s.error="Load failed. Server or network problems.",c.reject()})),c.promise},toJson:function(){var e={},t=this;return Object.keys(this).forEach(function(n){"originalData"!=n&&(e[n]=t[n])}),JSON.stringify(e)}},o}]),angular.module("app.services.concepts",["app.services.backend","app.services.concept"]).service("Concepts",["$rootScope","$q","$timeout","$state","Backend","Concept",function(e,t,n,r,o,s){"use strict";function c(t){a||(t!=u&&(i.concepts=[],u=t),console.log("[Concepts] fetchConcepts"),a=!0,o.getConcepts(i.cursor,t).success(function(t){return a=!1,t.concepts?(i.count=t.count,i.count!=i.concepts.length&&(i.concepts=[]),i.cursor=t.cursor,t.concepts.forEach(function(e,t){i.cursor+t;i.getByUri(e.uri)||i.concepts.push(new s(e.id,e.uri,e.label))}),console.log("[Concepts] Fetched"),void e.$broadcast("loadedConcepts",i.concepts)):void console.log("[Concepts] Fetch failed!")}))}var a=!1,i=this,l=null,u=null;this.concepts=[],this.cursor=0,this.count=0,e.$on("conceptChanged",function(e,t){l=t,l.data||l.load()}),e.$on("conceptLabelChanged",function(){console.log("Label changed, re-sort list")}),this.getConcepts=function(){return i.concepts},this.fetch=function(e){c(e)},this.getById=function(e){return i.concepts.reduce(function(t,n){return n.id==e?n:t},null)},this.getByUri=function(e){return i.concepts.reduce(function(t,n){return n.uri==e?n:t},null)},this.sort=function(){i.concepts.sort(function(e,t){return e.label.localeCompare(t.label)})},this.add=function(e,t){var n=new s(e,t,"(...)");return i.concepts.push(n),n},this.show=function(e){r.go("concepts.concept",{id:e.id})},this.next=function(){var e=i.concepts.indexOf(l),t=e+1;t>i.concepts.length-1&&(t=0),i.show(i.concepts[t])},this.prev=function(){var e=i.concepts.indexOf(l),t=e-1;0>t&&(t=i.concepts.length-1),i.show(i.concepts[t])}}]),angular.module("app.services.state",["app.services.concepts"]).service("StateService",["$rootScope","Concepts",function(e){"use strict";var t={concept:null,term:null,view:null};this.setView=function(n){t.view=n,console.log("[state] > New view"),console.log(n),e.$broadcast("viewChanged",t.view)},this.getView=function(){return t.view},this.setConcept=function(n){t.concept=n,e.$broadcast("conceptChanged",t.concept)},this.getConcept=function(){return t.concept},this.setTerm=function(n){t.term=n,e.$broadcast("termChanged",t.term)},this.getTerm=function(){return t.term}}]),angular.module("app.services.user",["app.services.backend"]).factory("User",["$q","$rootScope","$timeout","Backend",function(e,t,n,r){"use strict";function o(){var e=this;e.data=null}return o.prototype={constructor:o,isLoaded:function(){return this.data},setData:function(e){this.data=e}},o.get=function(t){var n=e.defer();return r.getUser(t).then(function(e){console.log(e),n.resolve(e)}),n.promise},o}]);